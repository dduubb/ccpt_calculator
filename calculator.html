<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Cook County Tax Calculator – MVP (Solve-For + Exemptions List)</title>
</head>
<style>:root{--bg:#0b1020;--panel:#121a32;--ink:#e9ecf1;--muted:#9aa6c3;--accent:#6aa7ff;--ok:#5dd39e;--warn:#ffd166;--bad:#ff6b6b;--radius:14px}*{box-sizing:border-box}body,html{height:100%}body{margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 80% -10%,#1b2547,#0b1020);color:var(--ink)}.wrap{max-width:1200px;margin:24px auto;padding:0 16px}header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}h1{font-size:20px;margin:0}.pill{padding:6px 10px;border-radius:999px;background:#0f1730;color:var(--muted);border:1px solid #1f2a52}.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}.card{background:var(--panel);border:1px solid #1f2a52;border-radius:var(--radius);box-shadow:0 10px 24px rgba(0,0,0,.18)}.card h2{font-size:14px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin:0 0 8px}.card .body{padding:16px}.row{display:grid;grid-template-columns:180px 1fr 200px;gap:10px;align-items:center;margin:10px 0}label{color:var(--muted)}input[type=number],input[type=text],select{width:100%;padding:10px 12px;background:#0f1730;color:var(--ink);border:1px solid #24305e;border-radius:10px}input:focus,select:focus{outline:0;border-color:var(--accent);box-shadow:0 0 0 3px #6aa7ff33}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}.muted{color:var(--muted)}.stat{display:flex;align-items:baseline;justify-content:space-between;padding:10px 0;border-bottom:1px dashed #263266}.stat:last-child{border-bottom:0}.stat .k{color:#a9b4d9}.stat .v{font-weight:600}.trace pre{margin:0;white-space:pre-wrap;word-break:break-word}.footer{display:flex;gap:10px;flex-wrap:wrap;padding:12px 16px;border-top:1px solid #1f2a52}button{background:#16224a;border:1px solid #25367a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}button:hover{background:#1a2a5a}.ok{color:var(--ok)}.warn{color:var(--warn)}.hint{color:var(--muted);font-size:12px}.given::after{content:"●";color:var(--accent);margin-left:6px;font-size:10px;vertical-align:middle}.bad{border-color:var(--bad)!important;background:#3a1520}.bang{color:var(--bad);font-weight:700}@media (max-width:1050px){.grid{grid-template-columns:1fr}}table{width:100%;border-collapse:collapse}thead th{font-weight:600;text-align:left;color:var(--muted);padding:8px;border-bottom:1px solid #25305a}tbody td{padding:8px;border-bottom:1px dashed #23305c}tbody tr:last-child td{border-bottom:0}.tinput{width:100%;padding:8px 10px;background:#0f1730;color:var(--ink);border:1px solid #24305e;border-radius:8px}.tinput.bad{border-color:var(--bad);background:#3a1520}.row-actions{display:flex;gap:8px}.small{font-size:12px;color:var(--muted)}.is-derived{border-color:#4b6fda;box-shadow:0 0 0 2px #4b6fda55 inset}.chip{display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:2px 6px;border-radius:999px;background:#0e1c46;border:1px solid #294bb0;color:#b7c8ff}</style>
<body>
<div class=wrap>
<header>
<h1>Cook County Tax Calculator — <span class=muted>Solve‑For MVP (Single File)</span></h1>
<div class="pill mono" id=version>Rules: 2025.v0 (demo)</div>
</header>
<div class=grid>
<section class=card>
<div class=body>
<h2>Inputs (type what you know)</h2>
<div class=row>
<label for=taxYear>Tax Year</label>
<select id=taxYear></select>
<div class=hint>Latest first</div>
</div>
<div class=row>
<label for=classCode>Assessment Class (→ Level %)</label>
<select id=classCode>
<option value=2 selected>2 — Residential</option>
<option value=3>3 — Multifamily</option>
<option value=5>5 — Commercial & Industrial</option>
<option value=4>4 — Not for Profit</option>
<option value=1>1 — Vacant</option>
<option value=0>0 — Exempt</option>
<option value=A>A — Incentive Class</option>
<option value=B>B — Incentive Class</option>
</select>
<div class=hint style=display:flex;gap:6px;align-items:center>
<span class=muted>Level %</span>
<input id=assess type=number inputmode=decimal step=0.0001 min=0 max=100 style=width:110px readonly>
</div>
</div>
<div class=row>
<label for=eq>Equalization Factor</label>
<input id=eq type=number inputmode=decimal placeholder=3.0000 min=0 step=0.0001>
<div class=hint><label style=display:flex;align-items:center;gap:6px;cursor:pointer><input id=autoEq type=checkbox checked> Auto‑fill from Tax Year</label></div>
</div>
<div class=row>
<label for=rate>Composite Tax Rate (%)</label>
<input id=rate type=number inputmode=decimal placeholder="" min=0 step=0.001>
<div class=hint>e.g., 7</div>
</div>
<hr style="border:none;border-top:1px solid #1f2a52;margin:14px 0">
<h2>Exemptions</h2>
<div class=small>Enter either the <b>Bill Reduction ($)</b> or the <b>Equalized EAV Reduction (AEAV)</b> for each exemption. If the <b>Tax Rate</b> is present, the other field auto-computes. Totals feed the AAV/AEAV math.</div>
<div style="margin:10px 0">
<button id=addEx>+ Add Exemption</button>
<button id=clearEx>Clear</button>
<button id=runTests title="Run built-in self tests">Run Self‑Tests</button>
</div>
<table>
<thead>
<tr>
<th style=width:35%>Label</th>
<th style=width:32%>Bill Reduction ($)</th>
<th style=width:28%>AEAV Reduction</th>
<th style=width:5%></th>
</tr>
</thead>
<tbody id=exRows></tbody>
</table>
<div class=small style=margin-top:6px>Totals: <span id=exTotals class=mono>$0.00 (bill), 0 AEAV; → AAV reduction computed using Eq</span></div>
<div class="small mono" id=testOut style=white-space:pre-wrap;margin-top:6px></div>
<hr style="border:none;border-top:1px solid #1f2a52;margin:14px 0">
<div class=row>
<label for=mv>Market Value (MV $)</label>
<input id=mv type=number inputmode=decimal placeholder="" min=0 step=1000>
<div id=mvMsg class=hint></div>
</div>
<div class=row>
<label for=av>Assessed Value (AV $)</label>
<input id=av type=number inputmode=decimal placeholder="" min=0 step=100>
<div id=avMsg class=hint></div>
</div>
<div class=row>
<label for=aav>Adjusted Assessed Value (AAV $)</label>
<input id=aav type=number inputmode=decimal placeholder="" min=0 step=100>
<div id=aavMsg class=hint></div>
</div>
<div class=row>
<label for=aeav>Adjusted Equalized AV (AEAV $)</label>
<input id=aeav type=number inputmode=decimal placeholder="" min=0 step=100>
<div id=aeavMsg class=hint></div>
</div>
<div class=row>
<label for=tax>Gross Tax ($)</label>
<input id=tax type=number inputmode=decimal placeholder="" min=0 step=1>
<div id=taxMsg class=hint></div>
</div>
<div class=row id=rowFreeze style=display:none>
<label for=freezeBase>Senior Freeze Base (AEAV $)</label>
<input id=freezeBase type=number inputmode=decimal placeholder="" readonly>
<div class=hint>Appears when a Senior Freeze (F) exemption is present</div>
</div>
</div>
<div class=footer>
<button id=reset>Reset</button>
<button id=exportJson>Export Trace JSON</button>
</div>
</section>
<section class=card style=display:none aria-hidden=true>
<div class=body>
<h2>Results</h2>
<div class=stat><div class=k>Market Value (MV)</div><div class="v mono" id=outMV>—</div></div>
<div class=stat><div class=k>Assessed Value (AV)</div><div class="v mono" id=outAV>—</div></div>
<div class=stat><div class=k>Adjusted Assessed Value (AAV = max(AV − Exemptions, 0))</div><div class="v mono" id=outAAV>—</div></div>
<div class=stat><div class=k>Adjusted Equalized AV (AEAV = AAV × Eq)</div><div class="v mono" id=outAEAV>—</div></div>
<div class=stat><div class=k>Gross Tax</div><div class="v mono ok" id=outTax>—</div></div>
<div class=stat><div class=k>Senior Freeze Base (AEAV)</div><div class="v mono" id=outFreezeBase>—</div></div>
<div class=muted style=margin-top:8px>Rounding: HALF_UP to cents at each stage.</div>
</div>
<div class="body trace">
<h2>Trace</h2>
<pre id=trace></pre>
</div>
</section>
</div>
</div>
<script>function populateTaxYearDropdown(){const e=document.getElementById("taxYear");if(!e)return;e.innerHTML="";const t=(new Date).getFullYear()-1;for(let n=t;n>=1995;n--){const t=document.createElement("option");t.value=String(n),t.textContent=String(n),e.appendChild(t)}e.value=String(t),state.set("taxYear",String(t))}function market_value_multiplier(e){const t={2:10,5:4,1:10,0:0,4:5};let n=null;try{n=parseInt(String(e).slice(0,3),10)}catch(e){n=null}if(Number.isFinite(n)&&t.hasOwnProperty(n))return t[n];return{A:6.6666,B:5}[String(e).slice(-1).toUpperCase()]??10}const EQ_BY_YEAR_FROM_1973=[1.4813,1.4453,1.4483,1.4153,1.4153,1.4966,1.6016,1.7432,1.8548,1.9288,1.9122,1.8445,1.8885,1.8486,1.8916,1.9266,1.9133,1.9946,2.0523,2.0897,2.1407,2.1135,2.1243,2.1517,2.1489,2.1799,2.2505,2.2235,2.3098,2.4689,2.4598,2.5757,2.732,2.7076,2.8439,2.9786,3.3701,3.3,2.9706,2.8056,2.6621,2.7253,2.6685,2.8032,2.9627,2.9109,2.916,3.2234,3.0027,2.9237,3.0163,3.0355,3,3];function lookupEqFromYear(e){const t=Number(e)-1973;return!Number.isFinite(t)||t<0||t>=EQ_BY_YEAR_FROM_1973.length?null:EQ_BY_YEAR_FROM_1973[t]}const $=e=>document.getElementById(e),state=new Map,given=new Set,status=new Map,msgs={mv:"mvMsg",av:"avMsg",aav:"aavMsg",aeav:"aeavMsg",tax:"taxMsg"};let exemptions=[],exIdSeq=1;function setState(e,t,n=!1){const a=document.getElementById(e);n&&(given.add(e),status.set(e,"locked"),markGivenLabel(e,!0),a&&a.classList.remove("is-derived")),""===t||null==t?(state.delete(e),n&&(status.set(e,"blank"),given.delete(e))):state.set(e,t),"taxYear"===e&&maybeAutoFillEq(),recompute()}function markGivenLabel(e,t){const n=document.querySelector(`label[for="${e}"]`);n&&n.classList.toggle("given",t)}const toCents=e=>null==e||""===e?null:Math.round(100*Number(e)),fromCents=e=>null==e?"—":(e/100).toLocaleString(void 0,{style:"currency",currency:"USD"}),fromCentsWhole=e=>null==e?"—":Math.round(e/100).toLocaleString();function mulDivRound(e,t,n){const a=Math.sign(e*t);return Math.floor((e*t+a*Math.floor(n/2))/n)}function mulByPercentCents(e,t){if(null==e||null==t)return null;return mulDivRound(e,Math.round(1e3*Number(t||0)),1e5)}function divByPercentCents(e,t){if(null==e||null==t)return null;const n=Math.round(1e3*Number(t||0));return n<=0?null:mulDivRound(e,1e5,n)}function mulByFactorCents(e,t){if(null==e||null==t)return null;return mulDivRound(e,Math.round(1e6*Number(t||0)),1e6)}function divByFactorCents(e,t){if(null==e||null==t)return null;const n=Math.round(1e6*Number(t||0));return n<=0?null:mulDivRound(e,1e6,n)}const max0=e=>null==e?null:e<0?0:e;function renderExemptions(){const e=$("exRows"),t=[{c:"H",n:"Homeowner"},{c:"S",n:"Senior"},{c:"F",n:"Senior Freeze"},{c:"R",n:"Returning Veteran"},{c:"P",n:"Disabled Person"},{c:"V",n:"Disabled Veteran"},{c:"L",n:"Longtime Homeowner"},{c:"I",n:"Homeowner Improvement"}];e.innerHTML=exemptions.map((e=>{const n=t.map((t=>`<option value="${t.c}" ${e.code===t.c?"selected":""}>${t.c} — ${t.n}</option>`)).join("");return`<tr data-id="${e.id}">\n        <td>\n          <select class="tinput" data-f="code">${n}</select>\n        </td>\n        <td><input class="tinput ${e.badSavings?"bad":""}" data-f="savings" inputmode="decimal" type="number" step="0.01" min="0" value="${null!=e.savingsC?(e.savingsC/100).toFixed(2):""}" placeholder="$"/></td>\n        <td><input class="tinput ${e.badAeav?"bad":""}" data-f="aeav" inputmode="decimal" type="number" step="0.01" min="0" value="${null!=e.aeavC?(e.aeavC/100).toFixed(2):""}" placeholder="AEAV"/></td>\n        <td class="row-actions"><button data-f="del">✕</button></td>\n      </tr>`})).join(""),updateExemptionTotals()}function addExemption(e="",t="H"){exemptions.push({id:exIdSeq++,code:t,label:e||{H:"Homeowner",S:"Senior",F:"Senior Freeze",R:"Returning Veteran",P:"Disabled Person",V:"Disabled Veteran",L:"Longtime Homeowner",I:"Homeowner Improvement"}[t]||"",savingsC:null,aeavC:null,givenSavings:!1,givenAeav:!1,badSavings:!1,badAeav:!1}),renderExemptions()}function clearExemptions(){exemptions=[],renderExemptions(),recompute()}function updateExemptionTotals(){const e=exemptions.reduce(((e,t)=>e+(t.savingsC||0)),0),t=exemptions.reduce(((e,t)=>e+(t.aeavC||0)),0),n=exemptions.filter((e=>"F"===e.code)).length;$("exTotals").textContent=`${fromCents(e)} (bill), ${(t/100).toLocaleString()} AEAV; ${n?"• Senior Freeze present":""} → AAV via Eq`}function computeAndSyncRow(e,t){const n=state.has("rate")?Number(state.get("rate")):null,a=null!=n&&n>0,s=t.querySelector('input[data-f="savings"]'),o=t.querySelector('input[data-f="aeav"]');if(e.badSavings=e.badAeav=!1,e.givenSavings&&!e.givenAeav?(e.aeavC=a?divByPercentCents(e.savingsC,n):null,o&&document.activeElement!==o&&(o.value=null==e.aeavC?"":(e.aeavC/100).toFixed(2))):e.givenAeav&&!e.givenSavings&&(e.savingsC=a?mulByPercentCents(e.aeavC,n):null,s&&document.activeElement!==s&&(s.value=null==e.savingsC?"":(e.savingsC/100).toFixed(2))),e.givenSavings&&e.givenAeav&&a){close(mulByPercentCents(e.aeavC,n),e.savingsC)||(e.badSavings=e.badAeav=!0)}s&&s.classList.toggle("bad",!!e.badSavings),o&&o.classList.toggle("bad",!!e.badAeav)}function syncExemptionRowInputs(){const e=$("exRows");exemptions.forEach((t=>{const n=e.querySelector(`tr[data-id="${t.id}"]`);n&&computeAndSyncRow(t,n)}))}function maybeAutoFillEq(){const e=document.getElementById("autoEq");if(!e||!e.checked)return;if(given.has("eq"))return;const t=lookupEqFromYear(document.getElementById("taxYear").value);if(null!=t){const e=document.getElementById("eq");document.activeElement!==e&&(e.value=t.toFixed(4)),state.set("eq",t.toFixed(4))}}function solve(){const e=Number(state.get("taxYear"))||2025,t=state.has("assess")?Number(state.get("assess")):10,n=state.has("eq")?Number(state.get("eq")):3,a=state.has("rate")?Number(state.get("rate")):null;let s=toCents(state.get("mv")),o=toCents(state.get("av")),l=toCents(state.get("aav")),r=toCents(state.get("aeav")),i=toCents(state.get("tax"));for(const e of["mv","av","aav","aeav","tax","assess","eq","rate"])setValid(e,!0,"");let u=0,d=0;if(exemptions.forEach((e=>{e.badSavings=!1,e.badAeav=!1;const t=null!=a&&a>0;if(e.givenSavings&&!e.givenAeav?e.aeavC=t?divByPercentCents(e.savingsC,a):null:e.givenAeav&&!e.givenSavings&&(e.savingsC=t?mulByPercentCents(e.aeavC,a):null),e.givenSavings&&e.givenAeav&&t){close(mulByPercentCents(e.aeavC,a),e.savingsC)||(e.badSavings=!0,e.badAeav=!0)}u+=e.savingsC||0,d+=e.aeavC||0})),syncExemptionRowInputs(),given.has("tax")&&null!=a){const e=divByPercentCents(i,a);null==e?setValid("tax",!1,"Need rate > 0"):(given.has("aeav")&&!close(r,e)&&(setValid("tax",!1,"≠ AEAV from rate"),setValid("aeav",!1,"≠ from tax")),r=r??e)}const c=divByFactorCents(d,n);if((given.has("aeav")||null!=r)&&null!=n){const e=divByFactorCents(r,n);null==e?setValid("aeav",!1,"Need eq > 0"):(given.has("aav")&&!close(l,e)&&(setValid("aav",!1,"≠ from AEAV"),setValid("aeav",!1,"≠ AAV with eq")),l=l??e)}if(given.has("aav")||null!=l){const e=(l??0)+(c??0);given.has("av")&&!close(o,e)&&(setValid("av",!1,"≠ from AAV + exemptions"),setValid("aav",!1,"≠ with AV − exemptions")),o=o??e,l<0&&setValid("aav",!1,"AAV < 0 impossible"),e<(c??0)&&setValid("aav",!1,"AAV < exemptions")}if((given.has("av")||null!=o)&&null!=t){const e=divByPercentCents(o,t);null==e?setValid("av",!1,"Need assessment > 0"):(given.has("mv")&&!close(s,e)&&(setValid("mv",!1,"≠ from AV"),setValid("av",!1,"≠ from MV")),s=s??e)}const v=mulByPercentCents(s??0,t??0),m=null==(g=(v??0)-(c??0))?null:g<0?0:g;var g;const p=mulByFactorCents(m??0,n??0),E=mulByPercentCents(p??0,a??0);return{taxYear:e,inputs:{assessPct:t,eq:n,ratePct:a,mvC:s,avC:o,aavC:l,aeavC:r,taxC:i,exBillTotalC:u,exAeavTotalC:d,exAavTotalC:c},derived:{AVf:v,AAVf:m,AEAVf:p,Taxf:E}}}function close(e,t,n=2){return null!=e&&null!=t&&Math.abs(e-t)<=n}function setValid(e,t,n){const a=$(e);if(!a)return;a.classList.toggle("bad",!t);const s=document.getElementById({mv:"mvMsg",av:"avMsg",aav:"aavMsg",aeav:"aeavMsg",tax:"taxMsg"}[e]||"");s&&(t?"av"===e?s.textContent="Assessed Valuation in PIN Research":s.innerHTML="":s.innerHTML=`<span class="bang">! </span>${n}`)}function setDerivedInputMoney(e,t){const n=document.getElementById(e);if(!n)return;if("locked"===status.get(e))return;if(null==t)return void("derived"===status.get(e)&&(n.value="",n.classList.remove("is-derived"),status.set(e,"blank")));const a=(t/100).toFixed(2);document.activeElement!==n&&(n.value=a),n.classList.add("is-derived"),status.set(e,"derived")}function setDerivedInputWhole(e,t){const n=document.getElementById(e);if(!n)return;if("locked"===status.get(e))return;if(null==t)return void("derived"===status.get(e)&&(n.value="",n.classList.remove("is-derived"),status.set(e,"blank")));const a=String(Math.round(t/100));document.activeElement!==n&&(n.value=a),n.classList.add("is-derived"),status.set(e,"derived")}function setDerivedInputRatePct(e,t){const n=document.getElementById(e);if(!n)return;if("locked"===status.get(e))return;if(null==t)return void("derived"===status.get(e)&&(n.value="",n.classList.remove("is-derived"),status.set(e,"blank")));const a=Number(t).toFixed(3);document.activeElement!==n&&(n.value=a),n.classList.add("is-derived"),status.set(e,"derived")}function recompute(){const e=solve(),{inputs:t,derived:n}=e,a=t.mvC??divByPercentCents(t.avC??n.AVf,t.assessPct),s=t.avC??n.AVf,o=t.aavC??n.AAVf,l=t.aeavC??n.AEAVf,r=t.taxC??n.Taxf;if($("outMV").textContent=fromCentsWhole(a),$("outAV").textContent=fromCentsWhole(s),$("outAAV").textContent=fromCentsWhole(o),$("outAEAV").textContent=fromCentsWhole(l),$("outTax").textContent=fromCents(r),setDerivedInputWhole("mv",a),setDerivedInputWhole("av",s),setDerivedInputWhole("aav",o),setDerivedInputWhole("aeav",l),setDerivedInputMoney("tax",r),!given.has("rate")&&null!=t.taxC){const e=exemptions.some((e=>null!=e.savingsC&&(null==e.aeavC||!e.givenAeav))),a=t.aeavC??n.AEAVf;if(!e&&null!=a&&a>0){setDerivedInputRatePct("rate",t.taxC/a*100)}}$("exTotals").textContent=`${fromCents(t.exBillTotalC)} (bill), ${(t.exAeavTotalC/100).toLocaleString()} AEAV; → ${(t.exAavTotalC/100).toLocaleString()} AAV via Eq`;const i={meta:{rulesVersion:$("version").textContent,rounding:"HALF_UP to cents"},inputs:{TaxYear:e.taxYear,MarketValue:null==a?null:a/100,AssessmentLevelPct:t.assessPct,EqualizationFactor:t.eq,CompositeRatePct:t.ratePct,AV_user:null==t.avC?null:t.avC/100,AAV_user:null==t.aavC?null:t.aavC/100,AEAV_user:null==t.aeavC?null:t.aeavC/100,Tax_user:null==t.taxC?null:t.taxC/100,Exemptions:exemptions.map((e=>({code:e.code,label:e.label,bill:null==e.savingsC?null:e.savingsC/100,aeav:null==e.aeavC?null:e.aeavC/100})))},steps:[{id:"Exemptions",formula:"Sum bill & AEAV; AAV_ex = AEAV_ex / Eq",value_cents:t.exAavTotalC},{id:"AV",formula:"AV = MV × Assessment% (HALF_UP)",value_cents:n.AVf},{id:"AAV",formula:"AAV = max(AV − AAV_ex, 0)",value_cents:n.AAVf},{id:"AEAV",formula:"AEAV = AAV × EqualizationFactor (HALF_UP)",value_cents:n.AEAVf},{id:"Tax",formula:"Tax = AEAV × CompositeRate% (HALF_UP)",value_cents:n.Taxf},{id:"FreezeBaseAEAV",formula:"Base = AEAV_taxable + FixedExemptions_AEAV (exclude Freeze)",value_cents:null}]},u=exemptions.some((e=>"F"===e.code));let d=null;const c=document.getElementById("rowFreeze");if(u){const e=exemptions.filter((e=>"F"===e.code)).reduce(((e,t)=>e+(t.aeavC||0)),0),a=t.exAeavTotalC-e,s=null!=t.aeavC?t.aeavC:n.AEAVf;d=null==s?null:s+a,$("outFreezeBase").textContent=fromCentsWhole(d),setDerivedInputWhole("freezeBase",d),c&&(c.style.display="grid"),i.steps=i.steps.map((e=>"FreezeBaseAEAV"===e.id?{...e,value_cents:d||0}:e))}else $("outFreezeBase").textContent="—",c&&(c.style.display="none"),setDerivedInputMoney("freezeBase",null),i.steps=i.steps.filter((e=>"FreezeBaseAEAV"!==e.id));$("trace").textContent=JSON.stringify({...i,steps:i.steps.map((e=>({id:e.id,formula:e.formula,value:e.value_cents/100})))},null,2)}function runSelfTests(){const e=$("testOut"),t=snapshotUI(),n=[];function a(e){n.push(e)}function s(e,t,n=1){return Math.abs(e-t)<=n}try{$("rate").value="7.188",setState("rate","7.188",!0),$("eq").value="1.4389",setState("eq","1.4389",!0),$("tax").value="3097.09",setState("tax","3097.09",!0),exemptions=[],addExemption("Homeowner","H"),addExemption("Senior","S"),addExemption("Senior Freeze","F");const o=$("exRows"),l=Array.from(o.querySelectorAll("tr")),r=[431.28,287.52,3286.71];l.forEach(((e,t)=>{const n=e.querySelector('input[data-f="savings"]');n.value=r[t].toFixed(2),n.dispatchEvent(new Event("input",{bubbles:!0}))})),recompute();const i=$("outAEAV").textContent.replace(/[^0-9.]/g,""),u=Number(i),d=$("outFreezeBase").textContent.replace(/[^0-9.]/g,""),c=Number(d);if(a(`Test1 AEAV=${u} (expect ~43087)`),a(`Test1 FreezeBase=${c} (expect ~53087)`),!s(u,43087,1))throw new Error("AEAV not within $1 of 43087");if(!s(c,53087,1))throw new Error("Freeze base not within $1 of 53087");a("✓ Test1 passed"),$("rate").value="7.000",setState("rate","7.000",!0),$("eq").value="3.0000",setState("eq","3.0000",!0),$("tax").value="700.00",setState("tax","700.00",!0),exemptions=[],addExemption("Homeowner","H");const v=$("exRows"),m=v.querySelector("tr").querySelector('input[data-f="savings"]');m.value="350.00",m.dispatchEvent(new Event("input",{bubbles:!0})),recompute();const g=$("outFreezeBase").textContent.trim(),p=$("trace").textContent;if(a(`Test2 FreezeBase display='${g}' (expect '—')`),"—"!==g)throw new Error("Freeze base should be hidden when no F exemption");if(/"FreezeBaseAEAV"/.test(p))throw new Error("Trace should not include FreezeBaseAEAV when no F exemption");a("✓ Test2 passed"),$("rate").value="",setState("rate","",!0),$("tax").value="",setState("tax","",!0),$("mv").value="300000",setState("mv","300000",!0),recompute();const E=document.getElementById("taxMsg").textContent.trim(),x=document.getElementById("tax").classList.contains("bad");if(a(`Test3 taxMsg='${E}', tax.bad=${x} (expect '', false)`),""!==E||x)throw new Error("Tax field should not warn when only MV is entered");document.getElementById("rate").value="",setState("rate","",!0),status.set("rate","blank"),document.getElementById("eq").value="3.0",setState("eq","3.0",!0),document.getElementById("assess").value="10",setState("assess","10",!0),exemptions=[],renderExemptions(),document.getElementById("mv").value="300000",setState("mv","300000",!0),document.getElementById("tax").value="6300.00",setState("tax","6300.00",!0),recompute();const f=document.getElementById("rate").value;if(a(`Test4 solved Rate=${f} (expect 7.000)`),"7.000"!==f)throw new Error("Rate should auto-solve to 7.000 from MV & Tax with no exemptions");document.getElementById("av").value="",setState("av","",!0),status.set("av","blank"),document.getElementById("aav").value="",setState("aav","",!0),status.set("aav","blank"),document.getElementById("aeav").value="",setState("aeav","",!0),status.set("aeav","blank"),recompute();const A=document.getElementById("av").value,C=document.getElementById("aav").value,y=document.getElementById("aeav").value;if(a(`Test7 derived AV=${A}, AAV=${C}, AEAV=${y}`),!(A&&C&&y))throw new Error("Derived values should populate AV/AAV/AEAV inputs");document.getElementById("av").value="32000.00",setState("av","32000.00",!0);const b=document.getElementById("av").value;if(recompute(),document.getElementById("av").value!==b)throw new Error("Locked AV should not be overwritten by derived recompute");document.getElementById("taxYear").value="2010",setState("taxYear","2010",!0),document.getElementById("eq").value="",setState("eq","",!1),maybeAutoFillEq();const h=document.getElementById("eq").value;if(a(`Test5 eq-from-year=${h} (expect 2.9706)`),"2.9706"!==h)throw new Error("Eq should auto-fill to 2.9706 for 2010");document.getElementById("classCode").value="5",document.getElementById("classCode").dispatchEvent(new Event("change",{bubbles:!0}));let S=document.getElementById("assess").value;if(a(`Test6 class 5 → assess=${S} (expect 4)`),"4"!==S)throw new Error("Class 5 should map to 4%");if(document.getElementById("classCode").value="0",document.getElementById("classCode").dispatchEvent(new Event("change",{bubbles:!0})),S=document.getElementById("assess").value,"0"!==S)throw new Error("Class 0 should map to 0%");if(document.getElementById("classCode").value="A",document.getElementById("classCode").dispatchEvent(new Event("change",{bubbles:!0})),S=document.getElementById("assess").value,"6.6666"!==S)throw new Error("Class A should map to 6.6666%");if(document.getElementById("classCode").value="B",document.getElementById("classCode").dispatchEvent(new Event("change",{bubbles:!0})),S=document.getElementById("assess").value,"5"!==S)throw new Error("Class B should map to 5%")}catch(e){a("✗ "+e.message)}finally{restoreUI(t),e.textContent=n.join("\n")}}function snapshotUI(){return{fields:["taxYear","assess","eq","rate","mv","av","aav","aeav","tax"].reduce(((e,t)=>{const n=document.getElementById(t);return e[t]=n?n.value:"",e}),{}),exemptions:JSON.parse(JSON.stringify(exemptions)),given:Array.from(given),status:Array.from(status.entries())}}function restoreUI(e){e&&((e.given||[]).forEach((e=>given.add(e))),(e.status||[]).forEach((([e,t])=>status.set(e,t))),Object.entries(e.fields||{}).forEach((([e,t])=>{const n=document.getElementById(e);n&&(n.value=t,""===t?state.delete(e):state.set(e,t))})),exemptions=e.exemptions||[],renderExemptions(),recompute())}$("addEx").addEventListener("click",(()=>{addExemption("","H")})),$("clearEx").addEventListener("click",(()=>{clearExemptions()})),$("runTests").addEventListener("click",runSelfTests),document.addEventListener("change",(e=>{e.target&&"autoEq"===e.target.id&&maybeAutoFillEq()})),document.addEventListener("change",(e=>{if(e.target&&"classCode"===e.target.id){const t=market_value_multiplier(e.target.value),n=document.getElementById("assess");n&&(n.value=t.toFixed(4).replace(/\.0000$/,"")),setState("assess",String(t),!0)}})),$("exRows").addEventListener("input",(e=>{const t=e.target.closest("tr");if(!t)return;const n=Number(t.dataset.id),a=exemptions.find((e=>e.id===n));if(!a)return;const s=e.target.dataset.f;if("code"!==s)"savings"===s&&(a.savingsC=""===e.target.value?null:toCents(e.target.value),a.givenSavings=!0,a.badSavings=!1),"aeav"===s&&(a.aeavC=""===e.target.value?null:toCents(e.target.value),a.givenAeav=!0,a.badAeav=!1),computeAndSyncRow(a,t),recompute();else{a.code=e.target.value;const t={H:"Homeowner",S:"Senior",F:"Senior Freeze",R:"Returning Veteran",P:"Disabled Person",V:"Disabled Veteran",L:"Longtime Homeowner",I:"Homeowner Improvement"};a.label=t[a.code]||""}})),$("exRows").addEventListener("click",(e=>{if(!e.target.closest("button"))return;const t=e.target.closest("tr"),n=Number(t.dataset.id);exemptions=exemptions.filter((e=>e.id!==n)),renderExemptions(),recompute()})),[["taxYear",""],["assess",""],["eq",""],["rate",""],["mv",""],["av",""],["aav",""],["aeav",""],["tax",""]].forEach((([e,t])=>$(e).addEventListener("input",(t=>{setState(e,t.target.value,!0)})))),["rate","mv","av","aav","aeav","tax"].forEach((e=>{const t=document.getElementById(e);t&&t.addEventListener("focus",(()=>{t.classList.remove("is-derived"),status.set(e,"derived"===status.get(e)?"blank":status.get(e)||"blank")}))})),document.getElementById("rate").addEventListener("input",(()=>{syncExemptionRowInputs()})),populateTaxYearDropdown(),function(){const e=market_value_multiplier(document.getElementById("classCode").value);document.getElementById("assess").value=String(e),state.set("assess",String(e))}(),setState("eq","",!1),maybeAutoFillEq(),document.getElementById("taxYear").addEventListener("change",(e=>setState("taxYear",e.target.value,!0))),addExemption("Homeowner","H"),addExemption("Senior","S"),addExemption("Senior Freeze","F"),$("reset").addEventListener("click",(()=>{given.clear(),status.clear(),exemptions=[],exIdSeq=1,renderExemptions(),["mv","av","aav","aeav","tax","rate","taxYear","assess","eq"].forEach((e=>{const t=$(e);t.value="",t.classList.remove("bad","is-derived");const n=document.querySelector(`label[for="${e}"]`);n&&n.classList.remove("given");const a=document.getElementById(e+"Msg");a&&(a.textContent="")})),populateTaxYearDropdown(),function(){const e=market_value_multiplier(document.getElementById("classCode").value);document.getElementById("assess").value=String(e),state.set("assess",String(e))}(),setState("eq","",!1),maybeAutoFillEq(),recompute()})),$("exportJson").addEventListener("click",(()=>{const e=new Blob([$("trace").textContent],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="tax-trace.json",n.click(),setTimeout((()=>URL.revokeObjectURL(t)),1500)})),renderExemptions(),recompute()</script>
</body>
</html>